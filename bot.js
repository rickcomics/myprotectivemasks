const express = require('express');
const app = express();

const PORT = process.env.PORT || 667;

// –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
app.get('/', (req, res) => {
  res.status(200).send('Bot is running');
});

// –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç /health –¥–ª—è –±–æ–ª–µ–µ —è–≤–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
app.get('/health', (req, res) => {
  res.status(200).json({ status: 'ok', timestamp: new Date().toISOString() });
});

app.listen(PORT, () => {
  console.log(`–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (–ø–æ—Ä—Ç ${PORT})`);
});

// –í–∞—à –∫–æ–¥ –±–æ—Ç–∞ (polling)
// ...


require('dotenv').config();
const { Bot, Keyboard } = require('grammy');

const bot = new Bot(process.env.BOT_API_KEY);

// 0. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
bot.use((ctx, next) => {
  console.log('[MIDDLEWARE] –ó–∞–ø—É—â–µ–Ω –¥–ª—è:', ctx.from?.id, '–¢–µ–∫—Å—Ç:', ctx.message?.text);
  return next();
});

// 1. –í–æ–ø—Ä–æ—Å—ã –ø–æ —Ä–æ–ª—è–º (3 –Ω–∞ –∫–∞–∂–¥—É—é)
const questions = {
  hero: [
    '–í—ã —á–∞—Å—Ç–æ –±–µ—Ä—ë—Ç–µ –Ω–∞ —Å–µ–±—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —á—É–∂–∏–µ –ø—Ä–æ–±–ª–µ–º—ã?',
    '–í–∞–º —Å–ª–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å "–Ω–µ—Ç", —á—Ç–æ–±—ã –Ω–µ –ø–æ–¥–≤–µ—Å—Ç–∏ –∫–æ–≥–æ‚Äë—Ç–æ?',
    '–í—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ —Å–µ–±—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è?'
  ],
  scapegoat: [
    '–í—ã –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–µ—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, –¥–∞–∂–µ –µ—Å–ª–∏ –º–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å –º–∏—Ä–Ω–æ?',
    '–í—ã –æ–±–≤–∏–Ω—è–µ—Ç–µ –¥—Ä—É–≥–∏—Ö –≤ —Å–≤–æ–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö?',
    '–í—ã —Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ –Ω–∞—Ä—É—à–∞–µ—Ç–µ –ø—Ä–∞–≤–∏–ª–∞, —á—Ç–æ–±—ã "–Ω–∞–∫–∞–∑–∞—Ç—å" –æ–∫—Ä—É–∂–∞—é—â–∏—Ö?'
  ],
  clown: [
    '–í—ã —à—É—Ç–∏—Ç–µ –≤ –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ—É–º–µ—Å—Ç–Ω–æ?',
    '–í—ã –∏–∑–±–µ–≥–∞–µ—Ç–µ —Å–µ—Ä—å—ë–∑–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤, –ø–µ—Ä–µ–≤–æ–¥—è –≤—Å—ë –≤ —à—É—Ç–∫—É?',
    '–í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —é–º–æ—Ä, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –±–æ–ª—å?'
  ],
  invisible: [
    '–í—ã –º–æ–ª—á–∏—Ç–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –º–Ω–µ–Ω–∏–µ?',
    '–í—ã –∏–∑–±–µ–≥–∞–µ—Ç–µ –≤–Ω–∏–º–∞–Ω–∏—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç —Ç—Ä–µ–≤–æ–≥—É?',
    '–í—ã –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç–µ –≤–∞–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏–∑‚Äë–∑–∞ —Å—Ç—Ä–∞—Ö–∞ –æ—à–∏–±–∏—Ç—å—Å—è?'
  ]
};

// 2. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏
const alternatives = {
  hero: [
    '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–∞–∑–∞—Ç—å "–Ω–µ—Ç" –±–µ–∑ —á—É–≤—Å—Ç–≤–∞ –≤–∏–Ω—ã.',
    '–ó–∞–ø–∏—à–∏—Ç–µ 3 —Å–≤–æ–∏—Ö –∂–µ–ª–∞–Ω–∏—è, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—è–º–∏.',
    '–ü–æ–∑–≤–æ–ª—å—Ç–µ —Å–µ–±–µ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å –±–µ–∑ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–π.'
  ],
  scapegoat: [
    '–ü–µ—Ä–µ–¥ —Ä–µ–∞–∫—Ü–∏–µ–π —Å–¥–µ–ª–∞–π—Ç–µ 3 –≥–ª—É–±–æ–∫–∏—Ö –≤–¥–æ—Ö–∞.',
    '–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ —Å–≤–æ—é –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å —Å–ª–æ–≤–∞–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–Ø –∑–ª—é—Å—å, –ø–æ—Ç–æ–º—É —á—Ç–æ...").',
    '–ù–∞–π–¥–∏—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± –≤—ã—Ä–∞–∑–∏—Ç—å –∑–ª–æ—Å—Ç—å (—Å–ø–æ—Ä—Ç, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ).'
  ],
  clown: [
    '–°–∫–∞–∂–∏—Ç–µ –ø—Ä—è–º–æ: "–ú–Ω–µ —Å–µ–π—á–∞—Å –Ω–µ–∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ".',
    '–ù–∞–ø–∏—à–∏—Ç–µ –≤ –∑–∞–º–µ—Ç–∫–∞—Ö, —á—Ç–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≤–∞—Å —Ç—Ä–µ–≤–æ–∂–∏—Ç.',
    '–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—è —é–º–æ—Ä.'
  ],
  invisible: [
    '–í—ã—Å–∫–∞–∂–∏—Ç–µ –º–Ω–µ–Ω–∏–µ –≤ —á–∞—Ç–µ (—Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ).',
    '–ó–∞–ø–∏—à–∏—Ç–µ 3 —Å–≤–æ–∏ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∑–∞ –¥–µ–Ω—å.',
    '–°–¥–µ–ª–∞–π—Ç–µ –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –∫ —Ü–µ–ª–∏ (–¥–∞–∂–µ 5 –º–∏–Ω—É—Ç).'
  ]
};

// 3. –í–µ—Å–∞ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –ø–æ—Ä–æ–≥–∏
const answerWeights = { –î–∞: 2, –ò–Ω–æ–≥–¥–∞: 1, –ù–µ—Ç: 0 };
const THRESHOLD_SINGLE = 4;  // –û–¥–Ω–∞ —Ä–æ–ª—å —Å ‚â•4 –±–∞–ª–ª–∞–º–∏ ‚Äî –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç
const THRESHOLD_MULTIPLE = 3; // –†–æ–ª–∏ —Å ‚â•3 –±–∞–ª–ª–∞–º–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–∞–∫–∏–µ


// 4. –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
const startKeyboard = new Keyboard()
  .add('–ù–∞—á–∞—Ç—å —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑').row().resized()
  .oneTime();

const feedbackKeyboard = new Keyboard()
  .add('–î–∞, —Å–æ–≥–ª–∞—Å–µ–Ω').resized()
  .add('–ù–µ—Ç, –Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω').resized()
  .oneTime();

// 5. –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const userState = new Map();


// 6. –ö–æ–º–∞–Ω–¥–∞ /start
bot.command('start', async (ctx) => {
  await ctx.reply(
    'üëã –ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è –∑–∞—â–∏—Ç–Ω—ã—Ö —Ä–æ–ª–µ–π –∏–∑ –¥–µ—Ç—Å—Ç–≤–∞.\n\n' +
    '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.',
    { reply_markup: startKeyboard }
  );
});

// 7. –ù–∞—á–∞–ª–æ —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞
bot.hears('–ù–∞—á–∞—Ç—å —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑', async (ctx) => {
  userState.set(ctx.from.id, {
    currentQuestion: 0,
    answers: [] // { role, answer, weight }
  });
  await askNextQuestion(ctx);
});

// 8. –ó–∞–¥–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
async function askNextQuestion(ctx) {
  const userId = ctx.from.id;
  const state = userState.get(userId);


  if (state.currentQuestion >= 12) {
    const detectedRoles = determineRoles(state.answers);
    await showResults(ctx, detectedRoles);
    return;
  }

  const roleIndex = Math.floor(state.currentQuestion / 3);
  const questionIndex = state.currentQuestion % 3;
  const roles = Object.keys(questions);
  const currentRole = roles[roleIndex];
  const question = questions[currentRole][questionIndex];

  const answerKeyboard = new Keyboard()
    .add('–î–∞')
    .row()
    .resized()
    .add('–ù–µ—Ç')
    .row()
    .resized()
    .add('–ò–Ω–æ–≥–¥–∞')
    .resized()
    .oneTime();

  await ctx.reply(question, { reply_markup: answerKeyboard });
}


// 9. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π
function determineRoles(answers) {
  const score = { hero: 0, scapegoat: 0, clown: 0, invisible: 0 };


  answers.forEach(({ role, weight }) => {
    score[role] += weight;
  });

  const detected = [];

  // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –¥–æ–º–∏–Ω–∏—Ä—É—é—â—É—é —Ä–æ–ª—å (‚â•4 –±–∞–ª–ª–æ–≤)
  for (const role in score) {
    if (score[role] >= THRESHOLD_SINGLE) {
      detected.push(role);
    }
  }

  // –ï—Å–ª–∏ –Ω–µ—Ç –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–π, –∏—â–µ–º –≤—Å–µ —Ä–æ–ª–∏ —Å ‚â•3 –±–∞–ª–ª–æ–≤
  if (detected.length === 0) {
    for (const role in score) {
      if (score[role] >= THRESHOLD_MULTIPLE) {
        detected.push(role);
      }
    }
  }

  return detected.length > 0 ? detected : ['neutral'];
}

// 10. –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
async function showResults(ctx, roles) {
  const roleNames = {
    hero: '–ì–µ—Ä–æ–π',
    scapegoat: '–ö–æ–∑—ë–ª –æ—Ç–ø—É—â–µ–Ω–∏—è',
    clown: '–®—É—Ç',
    invisible: '–ù–µ–≤–∏–¥–∏–º–∫–∞',
    neutral: '–ü—Ä–∏–∑–Ω–∞–∫–∏ —Ä–æ–ª–µ–π –Ω–µ –≤—ã—Ä–∞–∂–µ–Ω—ã —è—Ä–∫–æ'
  };

  if (roles[0] === 'neutral') {
    await ctx.reply(
      'üîç –ü—Ä–∏–∑–Ω–∞–∫–∏ —Ä–æ–ª–µ–π –Ω–µ –≤—ã—Ä–∞–∂–µ–Ω—ã —è—Ä–∫–æ. –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã —É–∂–µ –≤—ã—Ä–∞–±–æ—Ç–∞–ª–∏ –≥–∏–±–∫–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è.\n\n' +
      '–•–æ—Ç–∏—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑? –ù–∞–∂–º–∏—Ç–µ /start.',
      { reply_markup: feedbackKeyboard }
    );
    return;
  }

  let resultText = 'üé≠ –í—ã –ø—Ä–æ—è–≤–∏–ª–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏ —Å–ª–µ–¥—É—é—â–∏—Ö —Ä–æ–ª–µ–π:\n';
  for (const role of roles) {
    resultText += `‚Ä¢ ${roleNames[role]}\n`;
  }

  resultText += '\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:\n';

  for (const role of roles) {
    resultText += `\n*–î–ª—è —Ä–æ–ª–∏ "${roleNames[role]}":*\n`;
    resultText += alternatives[role].map((alt, i) =>
      `  ${i + 1}. ${alt}`
    ).join('\n');
  }

  resultText += '\n\nüìå –ü–æ–º–Ω–∏—Ç–µ: —ç—Ç–æ –Ω–µ –¥–∏–∞–≥–Ω–æ–∑, –∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞—Ç—å –Ω–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.';

  await ctx.reply(resultText, { parse_mode: 'Markdown' });

  // 11. –ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
  await ctx.reply(
    '–°–æ–≥–ª–∞—Å–Ω—ã –ª–∏ –≤—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏?',
    { reply_markup: feedbackKeyboard }
  );

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–æ–ª–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞
  userState.get(ctx.from.id).detectedRoles = roles;
}
// 12.
bot.hears(['–î–∞, —Å–æ–≥–ª–∞—Å–µ–Ω', '–ù–µ—Ç, –Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω'], async (ctx) => {
  const userId = ctx.from.id;
  const state = userState.get(userId);

  // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–ª–∏ —Ä–æ–ª–µ–π ‚Äî –≤—ã—Ö–æ–¥–∏–º
  if (!state || !state.detectedRoles) {
    console.log(`[ERROR] –ù–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
    return;
  }

  // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  userState.delete(userId);
  console.log(`[LOG] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –∑–∞–≤–µ—Ä—à–∏–ª —Ç–µ—Å—Ç. –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ.`);

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
  try {
    if (ctx.message.text === '–î–∞, —Å–æ–≥–ª–∞—Å–µ–Ω') {
      await ctx.reply(
        '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å! –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Å–¥–µ–ª–∞—Ç—å —Ç–µ—Å—Ç —Ç–æ—á–Ω–µ–µ.\n\n' +
        '–ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–Ω–∞–ª–∏–∑ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ  /start.',
        { reply_markup: { remove_keyboard: true } }
      );
    } else {
      await ctx.reply(
        '–ü–æ–Ω—è–ª. –°–ø–∞—Å–∏–±–æ –∑–∞ —á–µ—Å—Ç–Ω–æ—Å—Ç—å!\n\n' +
        '–í–æ–∑–º–æ–∂–Ω–æ, –≤–∞—à–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è —Å–ª–æ–∂–Ω–µ–µ, —á–µ–º –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç —ç—Ç–æ—Ç —Ç–µ—Å—Ç. ' +
        '–í–æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–¥–µ–π, –∫–∞–∫ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ:\n\n' +
        '1. –ó–∞–ø–∏—à–∏—Ç–µ 2‚Äì3 —Å–∏—Ç—É–∞—Ü–∏–∏, –≥–¥–µ –≤—ã —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∏ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–π—Ç–∏ –æ–±—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω.\n' +
        '2. –ü–æ–≥–æ–≤–æ—Ä–∏—Ç–µ —Å –±–ª–∏–∑–∫–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º, –∫–æ—Ç–æ—Ä–æ–º—É –¥–æ–≤–µ—Ä—è–µ—Ç–µ: –ø–æ–ø—Ä–æ—Å–∏—Ç–µ –µ–≥–æ –æ–ø–∏—Å–∞—Ç—å, –∫–∞–∫ –æ–Ω –≤–∏–¥–∏—Ç –≤–∞—à–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ —Å–ª–æ–∂–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–∞—Ö.\n' +
        '3. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Ç–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, –≤–∑–≥–ª—è–¥ –∏–∑–º–µ–Ω–∏—Ç—Å—è.\n\n' +
        '–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ, –Ω–∞–∂–º–∏—Ç–µ /start.',
        { reply_markup: { remove_keyboard: true } }
      );
    }


  } catch (error) {
    console.error('[ERROR] –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
  }

  return; // –Ø–≤–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
});


// 13.
bot.on('message', async (ctx) => {
  const userId = ctx.from.id;
  const state = userState.get(userId);
  const text = ctx.message.text;

  console.log('[DEBUG] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', text, 'UserID:', userId);

  // 1. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
  if (text === '–î–∞, —Å–æ–≥–ª–∞—Å–µ–Ω' || text === '–ù–µ—Ç, –Ω–µ —Å–æ–≥–ª–∞—Å–µ–Ω') {
    console.log('[DEBUG] –ü–µ—Ä–µ–¥–∞—ë–º –≤ bot.hears:', text);
    await bot.handleUpdate(ctx.update);
    return; // –Ø–≤–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
  }

  // 2. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
  if (text === '/start' || text === '–ù–∞—á–∞—Ç—å —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑') {
    console.log('[DEBUG] –ü–µ—Ä–µ–¥–∞—ë–º –≤ –∫–æ–º–∞–Ω–¥—É:', text);
    await bot.handleUpdate(ctx.update);
    return; // –Ø–≤–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
  }

  // 3. –ï—Å–ª–∏ —Ç–µ—Å—Ç –Ω–µ –Ω–∞—á–∞—Ç –∏–ª–∏ –∑–∞–≤–µ—Ä—à—ë–Ω
  if (!state || state.currentQuestion >= 12) {
    await ctx.reply(
      '–Ø –ø–æ–∫–∞ —É–º–µ—é —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–æ–¥–∏—Ç—å —Ç–µ—Å—Ç –Ω–∞ –≤—ã—è–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π.\n' +
      '–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –Ω–∞–∂–º–∏—Ç–µ /start.',
      { reply_markup: startKeyboard }
    );
    return;
  }

  // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞
  const validAnswers = ['–î–∞', '–ù–µ—Ç', '–ò–Ω–æ–≥–¥–∞'];
  if (!validAnswers.includes(text)) {
    await ctx.reply(
      '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫.',
      {
        reply_markup: new Keyboard()
          .add('–î–∞').row()
          .add('–ù–µ—Ç').row()
          .add('–ò–Ω–æ–≥–¥–∞').oneTime()
      }
    );
    return;
  }

  // 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
  try {
    const roleIndex = Math.floor(state.currentQuestion / 3);
    const roles = Object.keys(questions);
    const currentRole = roles[roleIndex];
    const weight = answerWeights[text] || 0;

    state.answers.push({ role: currentRole, answer: text, weight });
    state.currentQuestion++;

    await askNextQuestion(ctx);
  } catch (error) {
    console.error('[ERROR] –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞:', error);
    await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ: /start.');
  }
});


// 14. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
bot.catch((err, ctx) => {
  console.error('–û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ:', err);
  ctx.reply(
    '–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ: /start.'
  );
});

// 15. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.start();

console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...');
